<?php

function parse_forward_file ($data)
{
   $return = array();
   /*foreach ($data as $line)
   {
      if (strstr($line, "#####TYPE:") != FALSE)
         $return['type'] = str_replace ("#####TYPE:", "", $line);
      if (strstr($line, "#####EMAIL:") != FALSE)
         $return['emails'][] = str_replace ("#####EMAIL:", "", $line);
   }*/
  // if (empty($return))  // empty array, try detecting manually via regexp
 //  {
      if (preg_match ("/cc \"!(.*)\s*\"/",implode($data, "\n"),$matches) != 0)
      {
         $return['type'] = 'cc';
         $matches[1] = rtrim($matches[1]);
         $return['emails'] = explode (' ', $matches[1]);
      }
      if (preg_match ("/to \"!(.*)\s*\"/",implode($data, "\n"),$matches) != 0)
      {
         $return['type'] = 'to';
         $matches[1] = rtrim($matches[1]);
         $return['emails'] = explode (' ', $matches[1]);
      }
  // }
   return $return;
}

function make_forward_file ($data, $old)
{
   $rcmail = rcmail::get_instance();
   $olds = explode ("\n", $old);
   foreach ($olds as $id => $line)
      if ((strstr($line, "to \"!")) || (strstr($line, "cc \"!")) || ($line[0] == "#"))//(strstr($line, "# THIS FILE WAS CREATED BY A WEBTOOL DO NOT EDIT THIS FILE")))
         unset ($olds[$id]);
   //if ((empty($old)) || (count($olds) == 1) || (count($olds) == 0) || ($olds[0][0] == "\n") || !(strstr($old, "# THIS FILE WAS CREATED BY A WEBTOOL.")))
   //   $output .= "# THIS FILE WAS CREATED BY A WEBTOOL DO NOT EDIT THIS FILE\n";   // only add our warning comment if there isn't one already
   $old = implode ("\n", $olds);
   $old = $rcmail->config->get('warning_comment') . $old;
   $old = rtrim ($old) . "\n";  // make sure there is only a single newline at the end
   $output .= $old;
   if ($data['type'] == 'to')
      $forwardline = 'to "!';
   else                                // build forward line
      $forwardline = 'cc "!';
   foreach ($data['emails'] as $email)
   {
      $forwardline .= $email . ' ';
   }
   $forwardline = rtrim($forwardline);  // trim trailing space
   $output .= $forwardline . "\"\n\n";
   if (empty($data))
   {
      $olds = explode("\n", $old);
      foreach ($olds as $n => $line)
         if (($line[0] == "#") || empty($line)) unset ($olds[$n]);
      if (empty($olds))
         return '';
      else
         return $old;
   }
   return $output;
}

function remove_old_files() {
	$rcmail = rcmail::get_instance();
	$userinfo = get_userinfo();
	$USERNAME = $userinfo['username'];
	$RUNAS_CMD = $rcmail->config->get('RUNAS_CMD');
	$RM = $rcmail->config->get('RM');
	$files = array('.forward','.qmail');
	foreach($files as $value) {
		$user_cmd = "$RM $value";
		console($user_cmd);
		$exec_target = "$RUNAS_CMD $USERNAME $user_cmd";
		unset($result_arr);
		exec($exec_target, $result_arr, $status);
	}
}

?>
